<!-- d:\Github\Queue-augment\js\settings.html -->
<script>
   /**
 * Initializes interactions for the settings page, including tab switching
 * and button event listeners. This function should be called when the
 * settings section/page is made visible.
 */
function initializeSettingsPageInteractions() {
    console.log("Attempting to initialize settings page interactions from js/settings.html...");

    const settingsTabsContainer = document.getElementById('settingsTabs');
    const initSystemBtn = document.getElementById('runInitializeSystemBtn');
    const initSystemMessage = document.getElementById('initSystemMessage');
    // const generalSettingsFormArea = document.getElementById('generalSettingsFormArea'); // For future use
    // const soundManagementArea = document.getElementById('soundManagementArea'); // For future use
    // const announcementSettingsArea = document.getElementById('announcementSettingsContent'); // For future use

    // Tab switching logic
    if (settingsTabsContainer) {
        const tabButtons = Array.from(settingsTabsContainer.querySelectorAll('.settings-tab-button'));
        const tabPanesContainer = document.getElementById('settingsTabContent');

        if (!tabPanesContainer) {
            console.error("Element with ID 'settingsTabContent' not found. Tab panes cannot be managed.");
            // return; // Allow other initializations to proceed
        } else {
            const tabPanes = Array.from(tabPanesContainer.querySelectorAll('.settings-tab-pane'));

            function activateTab(buttonToActivate) {
                if (!buttonToActivate) return;

                tabButtons.forEach(btn => {
                    btn.setAttribute('aria-selected', 'false');
                    // Tailwind classes for inactive tabs (adjust if your default HTML is different)
                    btn.classList.remove('border-indigo-500', 'text-indigo-600', 'font-semibold', 'bg-indigo-50');
                    btn.classList.add('border-transparent', 'hover:text-gray-700', 'hover:border-gray-300', 'text-gray-500');
                });

                tabPanes.forEach(pane => {
                    pane.classList.add('hidden');
                });

                buttonToActivate.setAttribute('aria-selected', 'true');
                // Tailwind classes for active tab
                buttonToActivate.classList.add('border-indigo-500', 'text-indigo-600', 'font-semibold', 'bg-indigo-50');
                buttonToActivate.classList.remove('border-transparent', 'hover:text-gray-700', 'hover:border-gray-300', 'text-gray-500');

                const targetPaneId = buttonToActivate.dataset.tabsTarget; // Ensure buttons have data-tabs-target="#paneId"
                if (targetPaneId) {
                    const targetPane = tabPanesContainer.querySelector(targetPaneId);
                    if (targetPane) {
                        targetPane.classList.remove('hidden');
                    } else {
                        console.error(`Target pane ${targetPaneId} not found.`);
                    }
                }
            }

            let activeTabButton = tabButtons.find(btn => btn.getAttribute('aria-selected') === 'true');
            if (!activeTabButton && tabButtons.length > 0) {
                activeTabButton = tabButtons[0]; // Default to the first tab
            }
            
            if (activeTabButton) {
                activateTab(activeTabButton); // Initialize the view for the active tab
            }

            tabButtons.forEach(button => {
                if (button.dataset.tabListenerAttached !== 'true') {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        activateTab(this);
                    });
                    button.dataset.tabListenerAttached = 'true';
                }
            });
            console.log("Settings tab listeners attached/verified by initializeSettingsPageInteractions.");
        }
    } else {
        console.warn("Element with ID 'settingsTabs' not found. Tab functionality will not work.");
    }

    // "Initialize System" button logic (replaces the one in DOMContentLoaded)
    if (initSystemBtn) {
        if (initSystemBtn.dataset.initListenerAttached !== 'true') { // Use a unique dataset property
            initSystemBtn.addEventListener('click', handleInitializeSystem); // handleInitializeSystem is already defined below
            initSystemBtn.dataset.initListenerAttached = 'true';
            console.log("Initialize System button listener attached by initializeSettingsPageInteractions.");
        }
    } else {
        console.warn("Element with ID 'runInitializeSystemBtn' not found by initializeSettingsPageInteractions.");
    }
    console.log("Settings page interactions initialized or verified by initializeSettingsPageInteractions.");
}


document.addEventListener('DOMContentLoaded', function() {
    console.log("Settings script: DOMContentLoaded fired.");

    const runInitializeSystemBtn = document.getElementById('runInitializeSystemBtn');
    if (runInitializeSystemBtn) {
        console.log("Settings script: Found runInitializeSystemBtn, attaching listener.");
        // runInitializeSystemBtn.addEventListener('click', handleInitializeSystem); // Now handled by initializeSettingsPageInteractions
    } else {
        console.error("Settings script: runInitializeSystemBtn NOT FOUND.");
    }

    const saveGeneralSettingsBtn = document.getElementById('saveGeneralSettingsBtn');
    if (saveGeneralSettingsBtn) {
        // console.log("Settings script: Found saveGeneralSettingsBtn, attaching listener.");
        saveGeneralSettingsBtn.addEventListener('click', handleSaveGeneralSettings);
    } else {
        // console.error("Settings script: saveGeneralSettingsBtn NOT FOUND.");
    }
    
    // Display settings event listeners
    const displayTypeVideo = document.getElementById('displayTypeVideo');
    const displayTypeSlideshow = document.getElementById('displayTypeSlideshow');
    const saveDisplaySettingsBtn = document.getElementById('saveDisplaySettingsBtn');
    
    if (displayTypeVideo && displayTypeSlideshow) {
        displayTypeVideo.addEventListener('change', toggleDisplaySettingsSections);
        displayTypeSlideshow.addEventListener('change', toggleDisplaySettingsSections);
    }
    
    if (saveDisplaySettingsBtn) {
        saveDisplaySettingsBtn.addEventListener('click', handleSaveDisplaySettings);
    }
    
    const addSoundBtn = document.getElementById('addSoundBtn');
    if (addSoundBtn) {
        // console.log("Settings script: Found addSoundBtn, attaching listener.");
        addSoundBtn.addEventListener('click', handleAddSound);
    }
    const saveEditSoundBtn = document.getElementById('saveEditSoundBtn');
    if (saveEditSoundBtn) {
        saveEditSoundBtn.addEventListener('click', handleSaveEditSound);
    }
    const cancelEditSoundBtn = document.getElementById('cancelEditSoundBtn');
    if (cancelEditSoundBtn) {
        cancelEditSoundBtn.addEventListener('click', () => {
            const editModal = document.getElementById('editSoundModal');
            if (editModal) editModal.classList.add('hidden');
        });
    } else {
        // console.error("Settings script: cancelEditSoundBtn NOT FOUND (modal button).");
    }

    const saveAnnouncementSettingsBtn = document.getElementById('saveAnnouncementSettingsBtn');
    if (saveAnnouncementSettingsBtn) {
        saveAnnouncementSettingsBtn.addEventListener('click', handleSaveAnnouncementSettings);
    } else {
        console.error("Settings script: saveAnnouncementSettingsBtn NOT FOUND.");
    }
    
    // Queue Ticket Settings event listeners
    const saveQueueTicketSettingsBtn = document.getElementById('saveQueueTicketSettingsBtn');
    if (saveQueueTicketSettingsBtn) {
        saveQueueTicketSettingsBtn.addEventListener('click', handleSaveQueueTicketSettings);
    } else {
        console.error("Settings script: saveQueueTicketSettingsBtn NOT FOUND.");
    }

    // Initial data loading is now solely handled by onShowSettingsSection()
    // when the settingsSection is explicitly shown.
    // if (document.getElementById('settingsSection') && !document.getElementById('settingsSection').classList.contains('hidden')) {
    //     loadGeneralSettings();
    //     loadSoundData();
    // }
    // Tab switching logic from DOMContentLoaded is now handled by initializeSettingsPageInteractions
    // const tabButtons = document.querySelectorAll('.settings-tab-button');
    // const tabPanes = document.querySelectorAll('.settings-tab-pane');
    // ... (old tab logic removed for brevity, as initializeSettingsPageInteractions handles it)

    // const initialTabButton = document.getElementById('init-system-tab');
    // if (initialTabButton && tabButtons.length > 0 && tabPanes.length > 0) { ... } // Also handled by initializeSettingsPageInteractions


   
});
console.log("Settings script: Main event listener for DOMContentLoaded is set.");


function handleInitializeSystem() {
    const initSystemMessageEl = document.getElementById('initSystemMessage');
    const currentInitSystemBtn = document.getElementById('runInitializeSystemBtn'); // Get the button element

    initSystemMessageEl.textContent = 'กำลังดำเนินการเริ่มต้นระบบ...';
    initSystemMessageEl.className = 'mt-3 text-sm text-yellow-700';
     if(currentInitSystemBtn) currentInitSystemBtn.disabled = true;

    google.script.run
        .withSuccessHandler(function(response) {
            // Assuming response is a string from initializeSystem
            initSystemMessageEl.textContent = response || 'ดำเนินการเริ่มต้นระบบสำเร็จ!';
            console.log("Settings script: initializeSystem success:", response);
            initSystemMessageEl.className = 'mt-3 text-sm text-green-700';
           if(currentInitSystemBtn) currentInitSystemBtn.disabled = false;



        })
        .withFailureHandler(function(error) {
            initSystemMessageEl.textContent = 'เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message;
            console.error("Settings script: initializeSystem failure:", error);
            initSystemMessageEl.className = 'mt-3 text-sm text-red-700';
        })
        .initializeSystem();
}
console.log("Settings script: handleInitializeSystem function defined.");

function loadGeneralSettings() {
    const messageEl = document.getElementById('generalSettingsMessage');
    if (!messageEl) { console.error("loadGeneralSettings: messageEl not found"); return; }
    
    messageEl.textContent = 'กำลังโหลดการตั้งค่าทั่วไป...';
    messageEl.className = 'mt-3 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(settings) {
            if (settings) {
                const orgNameInput = document.getElementById('orgNameInput');
                const soundUrlInput = document.getElementById('soundUrlInput');
                // New announcement settings fields
                const announcementPatternInput = document.getElementById('announcementPatternInput');
                const counterAnnounceNumberRadio = document.getElementById('counterAnnounceNumber');
                const counterAnnounceNameSoundRadio = document.getElementById('counterAnnounceNameSound');

                if(orgNameInput) orgNameInput.value = settings.OrganizationName || ''; else console.error("loadGeneralSettings: orgNameInput not found");
                if(soundUrlInput) soundUrlInput.value = settings.SoundURL || ''; else console.error("loadGeneralSettings: soundUrlInput not found");
                
                // Populate announcement settings
                if(announcementPatternInput) announcementPatternInput.value = settings.default_announcement_pattern || ''; else console.error("loadGeneralSettings: announcementPatternInput not found");
                if(counterAnnounceNumberRadio && counterAnnounceNameSoundRadio) {
                    if (settings.counter_announcement_type === 'name_sound') {
                        counterAnnounceNameSoundRadio.checked = true;
                    } else {
                        counterAnnounceNumberRadio.checked = true; // Default to number
                    }
                } else { console.error("loadGeneralSettings: Counter announcement radio buttons not found"); }

                // Also load display settings
                loadDisplaySettings(settings);

                // Load Queue Ticket Settings
                const autoPrintEnabledRadio = document.getElementById('autoPrintEnabled');
                const autoPrintDisabledRadio = document.getElementById('autoPrintDisabled');
                const ticketTitleInput = document.getElementById('ticketTitleInput');
                const ticketWidthInput = document.getElementById('ticketWidthInput');
                const ticketHeightInput = document.getElementById('ticketHeightInput');

                if(autoPrintEnabledRadio && autoPrintDisabledRadio) {
                    if (settings.AutoPrintEnabled === 'enabled') autoPrintEnabledRadio.checked = true; else autoPrintDisabledRadio.checked = true;
                } else console.error("loadGeneralSettings: AutoPrint radio buttons not found");
                if(ticketTitleInput) ticketTitleInput.value = settings.TicketTitle || 'บัตรคิว'; else console.error("loadGeneralSettings: ticketTitleInput not found");
                if(ticketWidthInput) ticketWidthInput.value = settings.TicketWidth || '80'; else console.error("loadGeneralSettings: ticketWidthInput not found");
                if(ticketHeightInput) ticketHeightInput.value = settings.TicketHeight || '150'; else console.error("loadGeneralSettings: ticketHeightInput not found");

                messageEl.textContent = 'โหลดการตั้งค่าทั่วไปสำเร็จ';
                setTimeout(() => { messageEl.textContent = ''; }, 3000);
            } else {
                messageEl.textContent = 'ไม่พบข้อมูลการตั้งค่า';
                messageEl.className = 'mt-3 text-sm text-yellow-700';
            }
        })
        .withFailureHandler(function(error) {
            if(messageEl) {
                messageEl.textContent = 'เกิดข้อผิดพลาดในการโหลดการตั้งค่า: ' + error.message;
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .getSettings();
}

function loadDisplaySettings(settings) {
    // Get display settings elements
    const displayTypeVideo = document.getElementById('displayTypeVideo');
    const displayTypeSlideshow = document.getElementById('displayTypeSlideshow');
    const mediaUrlInput = document.getElementById('mediaUrlInput');
    const slideshowIntervalInput = document.getElementById('slideshowIntervalInput');
    const slideshowTransitionInput = document.getElementById('slideshowTransitionInput');
    const manageSlideshowImagesBtn = document.getElementById('manageSlideshowImagesBtn');
    
    // Set display type radio buttons
    if (displayTypeVideo && displayTypeSlideshow) {
        // Default to video if MediaURL is set, otherwise slideshow
        const hasMediaUrl = settings.MediaURL && settings.MediaURL.trim() !== '';
        
        if (settings.DisplayType === 'slideshow') {
            displayTypeSlideshow.checked = true;
        } else {
            displayTypeVideo.checked = true; // Default to video
        }
        
        // Toggle visibility of settings sections based on selected type
        toggleDisplaySettingsSections();
    }
    
    // Set other display settings
    if (mediaUrlInput) mediaUrlInput.value = settings.MediaURL || '';
    if (slideshowIntervalInput) slideshowIntervalInput.value = settings.SlideshowInterval || 7;
    if (slideshowTransitionInput && settings.SlideshowTransition) {
        slideshowTransitionInput.value = settings.SlideshowTransition;
    }
    
    // Add event listener for the "View Slideshow Images" button
    if (manageSlideshowImagesBtn) {
        manageSlideshowImagesBtn.addEventListener('click', function(e) {
            e.preventDefault();
            viewSlideshowImages();
        });
    }
}

// Function to view slideshow images from the SlideshowImages sheet
function viewSlideshowImages() {
    const messageEl = document.getElementById('displaySettingsMessage');
    if (messageEl) {
        messageEl.textContent = 'กำลังโหลดข้อมูลรูปภาพสไลด์โชว์...';
        messageEl.className = 'mt-3 text-sm text-purple-700';
    }
    
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success && response.data && response.data.length > 0) {
                // Create a modal to display the images
                const modal = document.createElement('div');
                modal.className = 'fixed z-50 inset-0 overflow-y-auto';
                modal.innerHTML = `
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="sm:flex sm:items-start">
                                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900">รูปภาพสไลด์โชว์ทั้งหมด</h3>
                                        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                            ${response.data.map(img => `
                                                <div class="border rounded-lg overflow-hidden">
                                                    <img src="${img.imageUrl}" alt="${img.title || 'Slideshow Image'}" class="w-full h-40 object-cover">
                                                    <div class="p-2 bg-gray-50">
                                                        <p class="text-sm font-medium">${img.title || 'ไม่มีชื่อ'}</p>
                                                        <p class="text-xs text-gray-500">ลำดับ: ${img.displayOrder || 0}</p>
                                                        <p class="text-xs text-gray-500">สถานะ: ${img.isActive ? 'แสดง' : 'ไม่แสดง'}</p>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <p class="mt-4 text-sm text-gray-500">หมายเหตุ: การแก้ไขรูปภาพสไลด์โชว์ต้องทำผ่านชีท "SlideshowImages" โดยตรง</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                    ปิด
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listener to close button
                modal.querySelector('.close-modal-btn').addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
                
                if (messageEl) {
                    messageEl.textContent = '';
                }
            } else {
                if (messageEl) {
                    messageEl.textContent = response.message || 'ไม่พบข้อมูลรูปภาพสไลด์โชว์';
                    messageEl.className = 'mt-3 text-sm text-yellow-600';
                }
            }
        })
        .withFailureHandler(function(error) {
            if (messageEl) {
                messageEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลรูปภาพ: ' + error.message;
                messageEl.className = 'mt-3 text-sm text-red-600';
            }
        })
        .getAllSlideshowImagesAdmin();
}

function toggleDisplaySettingsSections() {
    const videoSection = document.getElementById('videoSettingsSection');
    const slideshowSection = document.getElementById('slideshowSettingsSection');
    const displayTypeVideo = document.getElementById('displayTypeVideo');
    
    if (videoSection && slideshowSection && displayTypeVideo) {
        if (displayTypeVideo.checked) {
            videoSection.style.display = 'block';
            slideshowSection.style.display = 'none';
        } else {
            videoSection.style.display = 'none';
            slideshowSection.style.display = 'block';
        }
    }
}

function handleSaveGeneralSettings() {
    const messageEl = document.getElementById('generalSettingsMessage');
    if (!messageEl) { console.error("handleSaveGeneralSettings: messageEl not found"); return; }
    
    const orgNameInput = document.getElementById('orgNameInput');
    const soundUrlInput = document.getElementById('soundUrlInput');

    if (!orgNameInput || !soundUrlInput) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบช่องข้อมูลบางช่อง';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveGeneralSettings: One or more input fields not found.");
        return;
    }
    
    messageEl.textContent = 'กำลังบันทึกการตั้งค่า...';
    messageEl.className = 'mt-3 text-sm text-blue-700';

    const settingsToUpdate = {
        OrganizationName: orgNameInput.value.trim(),
        SoundURL: soundUrlInput.value.trim()
    };
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่าสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate); // Using the new batch update function
}

function handleSaveDisplaySettings() {
    const messageEl = document.getElementById('displaySettingsMessage');
    if (!messageEl) { console.error("handleSaveDisplaySettings: messageEl not found"); return; }

    const displayTypeVideo = document.getElementById('displayTypeVideo');
    const mediaUrlInput = document.getElementById('mediaUrlInput');
    // slideshowUrlsInput is no longer needed as we use SlideshowImages sheet
    const slideshowIntervalInput = document.getElementById('slideshowIntervalInput');
    const slideshowTransitionInput = document.getElementById('slideshowTransitionInput');

    if (!displayTypeVideo || !mediaUrlInput || !slideshowIntervalInput || !slideshowTransitionInput) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มบางส่วน';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveDisplaySettings: One or more form elements not found.");
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการตั้งค่าการแสดงผล...';
    messageEl.className = 'mt-3 text-sm text-purple-700';

    const displayType = displayTypeVideo.checked ? 'video' : 'slideshow';
    const slideshowInterval = parseInt(slideshowIntervalInput.value) || 7;

    const settingsToUpdate = {
        DisplayType: displayType,
        MediaURL: mediaUrlInput.value.trim(),
        SlideshowInterval: slideshowInterval,
        SlideshowTransition: slideshowTransitionInput.value
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่าการแสดงผลสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate);
}

function handleSaveAnnouncementSettings() {
    const messageEl = document.getElementById('announcementSettingsMessage');
    if (!messageEl) { console.error("handleSaveAnnouncementSettings: messageEl not found"); return; }

    const patternInput = document.getElementById('announcementPatternInput');
    const announceNumberRadio = document.getElementById('counterAnnounceNumber');

    if (!patternInput || !announceNumberRadio ) { // announceNameSoundRadio will exist if announceNumberRadio does
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มบางส่วน';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveAnnouncementSettings: One or more form elements not found.");
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการตั้งค่ารูปแบบเสียง...';
    messageEl.className = 'mt-3 text-sm text-blue-700';

    const settingsToUpdate = {
        default_announcement_pattern: patternInput.value.trim(),
        counter_announcement_type: announceNumberRadio.checked ? 'number' : 'name_sound'
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่ารูปแบบเสียงสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate);
}

function handleSaveQueueTicketSettings() {
    const messageEl = document.getElementById('queueTicketSettingsMessage');
    if (!messageEl) { console.error("handleSaveQueueTicketSettings: messageEl not found"); return; }

    const autoPrintEnabledRadio = document.getElementById('autoPrintEnabled');
    const ticketTitleInput = document.getElementById('ticketTitleInput');
    const ticketWidthInput = document.getElementById('ticketWidthInput');
    const ticketHeightInput = document.getElementById('ticketHeightInput');

    if (!autoPrintEnabledRadio || !ticketTitleInput || !ticketWidthInput || !ticketHeightInput) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มบางส่วน';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveQueueTicketSettings: One or more form elements not found.");
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการตั้งค่าบัตรคิว...';
    messageEl.className = 'mt-3 text-sm text-amber-700';

    const ticketWidth = parseInt(ticketWidthInput.value) || 80; // Default to 80mm if invalid
    const ticketHeight = parseInt(ticketHeightInput.value) || 150; // Default to 150mm if invalid

    const settingsToUpdate = {
        AutoPrintEnabled: autoPrintEnabledRadio.checked ? 'enabled' : 'disabled',
        TicketTitle: ticketTitleInput.value.trim() || 'บัตรคิว',
        TicketWidth: ticketWidth.toString(),
        TicketHeight: ticketHeight.toString()
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่าบัตรคิวสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate);
}

function loadSoundData() {
    const tableBody = document.getElementById('soundTableBody');
    const messageEl = document.getElementById('soundTableMessage');
    if (!tableBody) { console.error("loadSoundData: tableBody not found"); return; }
    if (!messageEl) { console.error("loadSoundData: messageEl not found"); }

    // ... rest of loadSoundData
    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">กำลังโหลดข้อมูลเสียง...</td></tr>'; // Adjusted colspan for 6 columns
    if(messageEl) messageEl.textContent = '';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success && response.data) {
                tableBody.innerHTML = ''; 
                if (response.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">ไม่พบข้อมูลเสียง</td></tr>'; // Adjusted colspan
                } else {
                    response.data.forEach(sound => {
                        const row = tableBody.insertRow();
                        // Added Description and Sound Type columns
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sound.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.nameSound}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs" title="${sound.linkSound}">${sound.linkSound}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.description || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.soundType || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="openEditSoundModal('${sound.id}', '${escapeJsString(sound.nameSound)}', '${escapeJsString(sound.linkSound)}', '${escapeJsString(sound.description)}', '${escapeJsString(sound.soundType)}')" class="text-indigo-600 hover:text-indigo-900 mr-2">แก้ไข</button>
                                <button onclick="handleDeleteSound('${sound.id}')" class="text-red-600 hover:text-red-900">ลบ</button>
                            </td>
                        `;
                    });
                }
                if(messageEl) messageEl.textContent = 'โหลดข้อมูลเสียงสำเร็จ';
            } else {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">เกิดข้อผิดพลาด: ' + (response.message || 'ไม่สามารถโหลดข้อมูลเสียง') + '</td></tr>'; // Adjusted colspan
                if(messageEl) {
                    messageEl.textContent = response.message || 'ไม่สามารถโหลดข้อมูลเสียง';
                    messageEl.className = 'mt-3 text-sm text-red-700';
                }
            }
             if(messageEl) setTimeout(() => { messageEl.textContent = ''; }, 3000);
        })
        .withFailureHandler(function(error) {
            tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Error: ' + error.message + '</td></tr>'; // Adjusted colspan
            if(messageEl) {
                messageEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลเสียง: ' + error.message;
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .getAllSoundData();
}

function escapeJsString(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}

function handleAddSound() {
    const nameInput = document.getElementById('newSoundName');
    const linkInput = document.getElementById('newSoundLink');
    const descriptionInput = document.getElementById('newSoundDescription'); // Assuming you add this input
    const typeInput = document.getElementById('newSoundType');       // Assuming you add this select/input
    const messageEl = document.getElementById('addSoundMessage');

    if (!nameInput || !linkInput || !descriptionInput || !typeInput || !messageEl) {
        console.error("handleAddSound: One or more form elements not found.");
        if(messageEl) messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์ม';
        return;
    }

    const nameSound = nameInput.value.trim();
    const linkSound = linkInput.value.trim();
    const description = descriptionInput.value.trim();
    const soundType = typeInput.value.trim();

    if (!nameSound || !linkSound) { // Basic validation, consider adding for description/type if mandatory
        messageEl.textContent = 'กรุณากรอกชื่อเสียงและลิงก์เสียง';
        messageEl.className = 'mt-2 text-sm text-red-700';
        return;
    }

    messageEl.textContent = 'กำลังเพิ่มเสียง...';
    messageEl.className = 'mt-2 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'เพิ่มเสียงสำเร็จ!';
                messageEl.className = 'mt-2 text-sm text-green-700';
                nameInput.value = '';
                linkInput.value = '';
                descriptionInput.value = '';
                typeInput.value = 'general_purpose'; // Reset to default
                loadSoundData(); 
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการเพิ่มเสียง';
                messageEl.className = 'mt-2 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageEl.className = 'mt-2 text-sm text-red-700';
        })
        .addSoundData(nameSound, linkSound, description, soundType); // Pass new fields
}

function openEditSoundModal(id, name, link, description, soundType) {
    const editSoundId = document.getElementById('editSoundId');
    const editSoundNameInput = document.getElementById('editSoundNameInput');
    const editSoundLinkInput = document.getElementById('editSoundLinkInput');
    const editSoundDescriptionInput = document.getElementById('editSoundDescriptionInput'); // Assuming you add this
    const editSoundTypeInput = document.getElementById('editSoundTypeInput');       // Assuming you add this
    const editSoundModalMessage = document.getElementById('editSoundModalMessage');
    const editSoundModal = document.getElementById('editSoundModal');

    if (!editSoundId || !editSoundNameInput || !editSoundLinkInput || !editSoundDescriptionInput || !editSoundTypeInput || !editSoundModalMessage || !editSoundModal) {
        console.error("openEditSoundModal: One or more modal elements not found.");
        alert("Error opening edit modal.");
        return;
    }

    editSoundId.value = id;
    editSoundNameInput.value = name;
    editSoundLinkInput.value = link;
    editSoundDescriptionInput.value = description || '';
    editSoundTypeInput.value = soundType || 'general_purpose';
    editSoundModalMessage.textContent = '';
    editSoundModal.classList.remove('hidden');
}

function handleSaveEditSound() {
    const id = document.getElementById('editSoundId').value;
    const nameInput = document.getElementById('editSoundNameInput');
    const linkInput = document.getElementById('editSoundLinkInput');
    const descriptionInput = document.getElementById('editSoundDescriptionInput'); // Assuming you add this
    const typeInput = document.getElementById('editSoundTypeInput');       // Assuming you add this
    const messageEl = document.getElementById('editSoundModalMessage');
    const editModal = document.getElementById('editSoundModal');


    if (!nameInput || !linkInput || !descriptionInput || !typeInput || !messageEl || !editModal) {
        console.error("handleSaveEditSound: One or more modal form elements not found.");
        if(messageEl) messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มโมดัล';
        return;
    }

    const nameSound = nameInput.value.trim();
    const linkSound = linkInput.value.trim();
    const description = descriptionInput.value.trim();
    const soundType = typeInput.value.trim();

    if (!nameSound || !linkSound) { // Basic validation
        messageEl.textContent = 'กรุณากรอกชื่อเสียงและลิงก์เสียง';
        messageEl.className = 'px-6 py-2 text-sm text-red-700';
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการแก้ไข...';
    messageEl.className = 'px-6 py-2 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการแก้ไขสำเร็จ!';
                messageEl.className = 'px-6 py-2 text-sm text-green-700';
                setTimeout(() => {
                    editModal.classList.add('hidden');
                    loadSoundData(); 
                }, 1500);
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'px-6 py-2 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageEl.className = 'px-6 py-2 text-sm text-red-700';
        })
        .updateSoundData(id, nameSound, linkSound, description, soundType); // Pass new fields
}

function handleDeleteSound(id) {
    if (!confirm(`คุณต้องการลบเสียง ID: ${id} ใช่หรือไม่?`)) {
        return;
    }
    const messageEl = document.getElementById('soundTableMessage');
    messageEl.textContent = `กำลังลบเสียง ID: ${id}...`;
    if (!messageEl) { console.error("handleDeleteSound: messageEl not found"); return; }
    messageEl.className = 'mt-3 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'ลบเสียงสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
                loadSoundData();
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการลบเสียง';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .deleteSoundData(id);
}

// Function to be called when settingsSection becomes visible
function onShowSettingsSection() {
    console.log("Settings section shown, loading data...");
     initializeSettingsPageInteractions(); // Initialize or re-initialize interactions
    loadGeneralSettings();
    loadSoundData();
    // Add loading for Announcement Settings tab if you create one
}
// Make sure onShowSettingsSection is called when the settings tab/section is actually made visible by your main navigation logic.
// d:\Github\Queue-augment\js\settings.js



</script>
